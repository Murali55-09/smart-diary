<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dilse.ai - Emotional Insights</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #0c0908;
      --accent-gold: #d4af37;
      --text-main: #fcf9f2;
      --text-dim: #a08a70;
      --glass-bg: rgba(28, 20, 15, 0.6);
      --glass-border: rgba(160, 138, 112, 0.15);
      --shadow-gold: 0 10px 40px rgba(212, 175, 55, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Bokeh Background */
    .bokeh-overlay {
      position: fixed;
      inset: 0;
      z-index: -1;
      background: radial-gradient(circle at 50% 50%, #1a1412 0%, #0c0908 100%);
    }

    .bokeh {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.1;
    }

    header {
      padding: 4rem 1rem 2rem;
      text-align: center;
      position: relative;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2rem, 6vw, 3rem);
      font-weight: 700;
      background: linear-gradient(to bottom, #fff, #d4af37);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .back-btn {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--accent-gold);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: var(--accent-gold);
      color: #000;
      transform: translateY(-50%) scale(1.1);
    }

    main {
      flex: 1;
      padding: 2rem 1rem 5rem;
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }

    .chart-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      padding: 3rem;
      box-shadow: var(--shadow-gold);
      animation: slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chart-header {
      margin-bottom: 3rem;
      text-align: center;
    }

    .chart-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      color: var(--text-main);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    .chart-header h2 i {
      color: var(--accent-gold);
      font-size: 1.5rem;
    }

    .chart-header p {
      color: var(--text-dim);
      font-size: 1rem;
      max-width: 500px;
      margin: 0 auto;
    }

    @media (max-width: 640px) {
      .chart-card {
        padding: 1.5rem;
      }

      header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>

<body>
  <div class="bokeh-overlay">
    <div class="bokeh" style="width: 500px; height: 500px; background: #2a1f1a; left: 10%; top: 10%;"></div>
    <div class="bokeh" style="width: 400px; height: 400px; background: #1e1a15; right: -10%; bottom: 10%;"></div>
  </div>

  <header>
    <button class="back-btn" onclick="window.location.href='/'">
      <i class="fas fa-arrow-left"></i>
    </button>
    <h1>Emotional Insights</h1>
  </header>

  <main>
    <div class="chart-card">
      <div class="chart-header">
        <h2><i class="fas fa-feather"></i> Your Inner Narrative</h2>
        <p>A visual representation of the emotional currents flowing through your journal entries.</p>
      </div>
      <div style="position: relative; height: 400px; width: 100%;">
        <canvas id="sentimentChart"></canvas>
      </div>
    </div>
  </main>

  <script>
    function getEmoji(score) {
      if (score <= -0.5) return 'üò¢';
      else if (score < 0) return 'üòü';
      else if (score === 0) return 'üòê';
      else if (score < 0.5) return 'üôÇ';
      else return 'üòÑ';
    }

    async function loadAndDrawChart() {
      try {
        const response = await fetch('/get_entries');
        const data = await response.json();

        if (data.length === 0) return;

        data.sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = data.map(entry => {
          const d = new Date(entry.date);
          return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const scores = data.map(entry => {
          let score = entry.score || 0;
          if (typeof score === 'string' && score.includes('%')) {
            score = (parseInt(score) / 50) - 1;
          }
          return score;
        });

        const ctx = document.getElementById('sentimentChart').getContext('2d');

        const goldGradient = ctx.createLinearGradient(0, 0, 0, 400);
        goldGradient.addColorStop(0, 'rgba(212, 175, 55, 0.2)');
        goldGradient.addColorStop(1, 'rgba(212, 175, 55, 0)');

        Chart.defaults.color = '#a08a70';
        Chart.defaults.font.family = "'Inter', sans-serif";

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Emotional Depth',
              data: scores,
              borderColor: '#d4af37',
              backgroundColor: goldGradient,
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: '#d4af37',
              pointBorderColor: '#0c0908',
              pointBorderWidth: 2
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(21, 17, 15, 0.95)',
                titleColor: '#d4af37',
                titleFont: { family: "'Playfair Display', serif", size: 14 },
                bodyColor: '#fcf9f2',
                padding: 15,
                cornerRadius: 15,
                borderColor: 'rgba(212, 175, 55, 0.2)',
                borderWidth: 1,
                displayColors: false,
                callbacks: {
                  label: function (context) {
                    const score = context.raw;
                    return ` Resilience: ${Math.round((score + 1) * 50)}% ${getEmoji(score)}`;
                  }
                }
              }
            },
            scales: {
              y: {
                min: -1.2,
                max: 1.2,
                grid: { color: 'rgba(160, 138, 112, 0.1)' },
                ticks: {
                  callback: function (value) {
                    if (value === 1) return 'üòÑ Radiant';
                    if (value === 0) return 'üòê Balanced';
                    if (value === -1) return 'üò¢ Reflective';
                    return '';
                  }
                }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      } catch (err) {
        console.error("Failed to load or draw chart:", err);
      }
    }

    loadAndDrawChart();
  </script>
</body>

</html>